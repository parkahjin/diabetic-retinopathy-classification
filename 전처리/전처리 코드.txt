# ===================================================================
# Cell 2: ë°ì´í„° ë¡œë“œ ë° Train/Val ë¶„í• 
# ===================================================================

# ë°ì´í„° ê²½ë¡œ ì„¤ì •
DATA_DIR = '/kaggle/input/diabetic-retinopathy-resized'
TRAIN_DIR = f'{DATA_DIR}/resized_train/resized_train'
LABELS_FILE = f'{DATA_DIR}/trainLabels.csv'

# ë ˆì´ë¸” ë¡œë“œ
print("ğŸ“‚ ë ˆì´ë¸” íŒŒì¼ ë¡œë“œ ì¤‘...")
labels_df = pd.read_csv(LABELS_FILE)
print(f"   ì´ ë°ì´í„° ê°œìˆ˜: {len(labels_df):,}ê°œ")

# 2-class ë³€í™˜ (0 = ì •ìƒ, 1-4 = ë¹„ì •ìƒ)
labels_df['binary_label'] = labels_df['level'].apply(lambda x: 0 if x == 0 else 1)

# í´ë˜ìŠ¤ ë¶„í¬ í™•ì¸
print("\nğŸ“Š ì›ë³¸ 5-class ë¶„í¬:")
print(labels_df['level'].value_counts().sort_index())

print("\nğŸ“Š 2-class ë³€í™˜ í›„ ë¶„í¬:")
class_counts = labels_df['binary_label'].value_counts().sort_index()
print(f"   ì •ìƒ (0): {class_counts[0]:,}ê°œ ({class_counts[0]/len(labels_df)*100:.1f}%)")
print(f"   ë¹„ì •ìƒ (1): {class_counts[1]:,}ê°œ ({class_counts[1]/len(labels_df)*100:.1f}%)")
print(f"   ë¶ˆê· í˜• ë¹„ìœ¨: {class_counts[0]/class_counts[1]:.2f}:1")

# Train/Val ë¶„í•  (80/20, Stratified)
train_df, val_df = train_test_split(
    labels_df,
    test_size=0.2,
    stratify=labels_df['binary_label'],
    random_state=SEED
)

print(f"\nâœ‚ï¸ Train/Val ë¶„í•  ì™„ë£Œ!")
print(f"   Train: {len(train_df):,}ê°œ")
print(f"   Val: {len(val_df):,}ê°œ")

print("\nğŸ“Š Train í´ë˜ìŠ¤ ë¶„í¬:")
train_counts = train_df['binary_label'].value_counts().sort_index()
print(f"   ì •ìƒ (0): {train_counts[0]:,}ê°œ")
print(f"   ë¹„ì •ìƒ (1): {train_counts[1]:,}ê°œ")

print("\nğŸ“Š Val í´ë˜ìŠ¤ ë¶„í¬:")
val_counts = val_df['binary_label'].value_counts().sort_index()
print(f"   ì •ìƒ (0): {val_counts[0]:,}ê°œ")
print(f"   ë¹„ì •ìƒ (1): {val_counts[1]:,}ê°œ")

print("\n" + "="*60)
print("âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ!")
print("="*60)
# ===================================================================
# Cell 3: ì˜¤ë²„ìƒ˜í”Œë§ (1:1 ë¹„ìœ¨ ë§ì¶”ê¸°)
# ===================================================================

print("ğŸ”„ ì˜¤ë²„ìƒ˜í”Œë§ ì‹œì‘...")
print(f"   í˜„ì¬ Train ë°ì´í„°: {len(train_df):,}ê°œ\n")

# í´ë˜ìŠ¤ë³„ë¡œ ë¶„ë¦¬
normal_df = train_df[train_df['binary_label'] == 0]      # ì •ìƒ
abnormal_df = train_df[train_df['binary_label'] == 1]    # ë¹„ì •ìƒ

print(f"   ì •ìƒ (0): {len(normal_df):,}ê°œ")
print(f"   ë¹„ì •ìƒ (1): {len(abnormal_df):,}ê°œ")
print(f"   ë¶ˆê· í˜• ë¹„ìœ¨: {len(normal_df)/len(abnormal_df):.2f}:1\n")

# ë¹„ì •ìƒ í´ë˜ìŠ¤ ì˜¤ë²„ìƒ˜í”Œë§ (ì •ìƒ ê°œìˆ˜ë§Œí¼ ë³µì œ)
target_count = len(normal_df)
print(f"ğŸ¯ ëª©í‘œ: ë¹„ì •ìƒ í´ë˜ìŠ¤ë¥¼ {target_count:,}ê°œë¡œ ëŠ˜ë¦¬ê¸°")

# ë³µì œ (replace=True: ì¤‘ë³µ í—ˆìš©)
abnormal_oversampled = abnormal_df.sample(
    n=target_count, 
    replace=True, 
    random_state=SEED
)

print(f"   ì˜¤ë²„ìƒ˜í”Œë§ í›„ ë¹„ì •ìƒ: {len(abnormal_oversampled):,}ê°œ")

# í•©ì¹˜ê¸°
train_balanced = pd.concat([normal_df, abnormal_oversampled], axis=0)

# ì„ê¸° (ì¤‘ìš”!)
train_balanced = train_balanced.sample(frac=1, random_state=SEED).reset_index(drop=True)

print(f"\nâœ… ì˜¤ë²„ìƒ˜í”Œë§ ì™„ë£Œ!")
print(f"   ìµœì¢… Train ë°ì´í„°: {len(train_balanced):,}ê°œ")

# ìµœì¢… ë¶„í¬ í™•ì¸
final_counts = train_balanced['binary_label'].value_counts().sort_index()
print(f"\nğŸ“Š ìµœì¢… Train í´ë˜ìŠ¤ ë¶„í¬:")
print(f"   ì •ìƒ (0): {final_counts[0]:,}ê°œ ({final_counts[0]/len(train_balanced)*100:.1f}%)")
print(f"   ë¹„ì •ìƒ (1): {final_counts[1]:,}ê°œ ({final_counts[1]/len(train_balanced)*100:.1f}%)")
print(f"   ê· í˜• ë¹„ìœ¨: {final_counts[0]/final_counts[1]:.2f}:1 â† ì™„ë²½í•œ ê· í˜•! âœ…")

print(f"\nğŸ“Š Val í´ë˜ìŠ¤ ë¶„í¬ (ë³€ê²½ ì—†ìŒ):")
print(f"   ì •ìƒ (0): {val_counts[0]:,}ê°œ")
print(f"   ë¹„ì •ìƒ (1): {val_counts[1]:,}ê°œ")

print("\n" + "="*60)
print("âœ… ì˜¤ë²„ìƒ˜í”Œë§ ì™„ë£Œ!")
print("="*60)
# ===================================================================
# Cell 4: ì „ì²˜ë¦¬ í•¨ìˆ˜ ì •ì˜
# ===================================================================

# ì„¤ì •ê°’
IMG_SIZE = 96

def preprocess_image(image_path):
    """
    CLAHE ì „ì²˜ë¦¬ + ë¦¬ì‚¬ì´ì¦ˆ + ì •ê·œí™”
    
    Args:
        image_path: ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
    
    Returns:
        ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ (128, 128, 3), ê°’ ë²”ìœ„ [0, 1]
    """
    try:
        # 1. ì´ë¯¸ì§€ ë¡œë“œ
        img = cv2.imread(image_path)
        if img is None:
            raise ValueError(f"ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: {image_path}")
        
        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        
        # 2. CLAHE
        lab = cv2.cvtColor(img, cv2.COLOR_RGB2LAB)
        l, a, b = cv2.split(lab)
        
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
        l_clahe = clahe.apply(l)
        
        lab_clahe = cv2.merge([l_clahe, a, b])
        img_clahe = cv2.cvtColor(lab_clahe, cv2.COLOR_LAB2RGB)
        
        # 3. ë¦¬ì‚¬ì´ì¦ˆ (128x128)
        img_resized = cv2.resize(img_clahe, (IMG_SIZE, IMG_SIZE))
        
        # 4. ì •ê·œí™”
        img_normalized = img_resized.astype(np.float32) / 255.0
        
        return img_normalized
    
    except Exception as e:
        print(f"âŒ ì „ì²˜ë¦¬ ì‹¤íŒ¨: {image_path} - {str(e)}")
        return np.zeros((IMG_SIZE, IMG_SIZE, 3), dtype=np.float32)


# í…ŒìŠ¤íŠ¸
print("ğŸ§ª ì „ì²˜ë¦¬ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸...")
test_image_name = train_balanced.iloc[0]['image']
test_image_path = f"{TRAIN_DIR}/{test_image_name}.jpeg"

print(f"   í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€: {test_image_name}.jpeg")

if os.path.exists(test_image_path):
    test_img = preprocess_image(test_image_path)
    print(f"   âœ… ì „ì²˜ë¦¬ ì„±ê³µ!")
    print(f"      - Shape: {test_img.shape}")
    print(f"      - Dtype: {test_img.dtype}")
    print(f"      - Min: {test_img.min():.3f}, Max: {test_img.max():.3f}")
    print(f"      - Mean: {test_img.mean():.3f}")
else:
    print(f"   âš ï¸ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

print("\n" + "="*60)
print("âœ… ì „ì²˜ë¦¬ í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ!")
print("="*60)
# ===================================================================
# Cell 5: ì „ì²˜ë¦¬ ì‹¤í–‰ (ë©”ëª¨ë¦¬ ì•ˆì „ ë²„ì „)
# ===================================================================

print("ğŸš€ ì „ì²˜ë¦¬ ì‹œì‘!\n")
print("â±ï¸ ì˜ˆìƒ ì†Œìš” ì‹œê°„: 7-10ë¶„")
print("=" * 60)

# ===== Train ë°ì´í„° ì „ì²˜ë¦¬ =====
print("\nğŸ“¦ Train ë°ì´í„° ì „ì²˜ë¦¬ ì¤‘...")
print(f"   ì´ {len(train_balanced):,}ê°œ ì´ë¯¸ì§€")

X_train = []
y_train = []

for idx, row in tqdm(train_balanced.iterrows(), 
                     total=len(train_balanced), 
                     desc="Train ì „ì²˜ë¦¬"):
    image_name = row['image']
    label = row['binary_label']
    image_path = f"{TRAIN_DIR}/{image_name}.jpeg"
    
    img = preprocess_image(image_path)
    X_train.append(img)
    y_train.append(label)

X_train = np.array(X_train, dtype=np.float32)
y_train = np.array(y_train, dtype=np.float32)

print(f"\nâœ… Train ì „ì²˜ë¦¬ ì™„ë£Œ!")
print(f"   X_train shape: {X_train.shape}")
print(f"   y_train shape: {y_train.shape}")
print(f"   ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {X_train.nbytes / (1024**3):.2f} GB")

# ===== Val ë°ì´í„° ì „ì²˜ë¦¬ =====
print("\nğŸ“¦ Val ë°ì´í„° ì „ì²˜ë¦¬ ì¤‘...")
print(f"   ì´ {len(val_df):,}ê°œ ì´ë¯¸ì§€")

X_val = []
y_val = []

for idx, row in tqdm(val_df.iterrows(), 
                     total=len(val_df), 
                     desc="Val ì „ì²˜ë¦¬"):
    image_name = row['image']
    label = row['binary_label']
    image_path = f"{TRAIN_DIR}/{image_name}.jpeg"
    
    img = preprocess_image(image_path)
    X_val.append(img)
    y_val.append(label)

X_val = np.array(X_val, dtype=np.float32)
y_val = np.array(y_val, dtype=np.float32)

print(f"\nâœ… Val ì „ì²˜ë¦¬ ì™„ë£Œ!")
print(f"   X_val shape: {X_val.shape}")
print(f"   y_val shape: {y_val.shape}")
print(f"   ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {X_val.nbytes / (1024**3):.2f} GB")

# ===== ìµœì¢… í™•ì¸ =====
print("\n" + "=" * 60)
print("ğŸ“Š ì „ì²˜ë¦¬ ìµœì¢… ìš”ì•½")
print("=" * 60)
print(f"Train: {X_train.shape[0]:,}ê°œ ì´ë¯¸ì§€")
print(f"   - ì •ìƒ: {np.sum(y_train == 0):,}ê°œ")
print(f"   - ë¹„ì •ìƒ: {np.sum(y_train == 1):,}ê°œ")
print(f"\nVal: {X_val.shape[0]:,}ê°œ ì´ë¯¸ì§€")
print(f"   - ì •ìƒ: {np.sum(y_val == 0):,}ê°œ")
print(f"   - ë¹„ì •ìƒ: {np.sum(y_val == 1):,}ê°œ")
print(f"\nì´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {(X_train.nbytes + X_val.nbytes) / (1024**3):.2f} GB")

# ===================================================================
# ğŸ†• ì•ˆì „í•œ ì €ì¥ (ë©”ëª¨ë¦¬ ì •ë¦¬ í¬í•¨)
# ===================================================================

print("\n" + "=" * 60)
print("ğŸ’¾ ì „ì²˜ë¦¬ ë°ì´í„° ì €ì¥ ì¤‘ (ì•ˆì „ ëª¨ë“œ)...")
print("=" * 60)

import gc

# 1. ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬
print("\nğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬ ì¤‘...")
gc.collect()
print("âœ… ë©”ëª¨ë¦¬ ì •ë¦¬ ì™„ë£Œ")

# 2. í•˜ë‚˜ì”© ì €ì¥ (ì§„í–‰ ìƒí™© í™•ì¸)
print("\nğŸ’¾ X_train ì €ì¥ ì¤‘...")
np.save('X_train.npy', X_train)
print(f"   âœ… X_train.npy ì €ì¥ ì™„ë£Œ ({X_train.nbytes / (1024**3):.2f} GB)")

print("ğŸ’¾ y_train ì €ì¥ ì¤‘...")
np.save('y_train.npy', y_train)
print(f"   âœ… y_train.npy ì €ì¥ ì™„ë£Œ ({y_train.nbytes / (1024**3):.2f} GB)")

print("ğŸ’¾ X_val ì €ì¥ ì¤‘...")
np.save('X_val.npy', X_val)
print(f"   âœ… X_val.npy ì €ì¥ ì™„ë£Œ ({X_val.nbytes / (1024**3):.2f} GB)")

print("ğŸ’¾ y_val ì €ì¥ ì¤‘...")
np.save('y_val.npy', y_val)
print(f"   âœ… y_val.npy ì €ì¥ ì™„ë£Œ ({y_val.nbytes / (1024**3):.2f} GB)")

# 3. ì €ì¥ ì™„ë£Œ í™•ì¸
print("\nğŸ” ì €ì¥ íŒŒì¼ í™•ì¸ ì¤‘...")
import os
files = ['X_train.npy', 'y_train.npy', 'X_val.npy', 'y_val.npy']
all_saved = True

for f in files:
    if os.path.exists(f):
        size = os.path.getsize(f) / (1024**3)
        print(f"   âœ… {f}: {size:.2f} GB")
    else:
        print(f"   âŒ {f}: ì €ì¥ ì‹¤íŒ¨!")
        all_saved = False

if all_saved:
    print("\nğŸ‰ ëª¨ë“  íŒŒì¼ ì €ì¥ ì„±ê³µ!")
else:
    print("\nâš ï¸ ì¼ë¶€ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨!")

print(f"\nğŸ’¡ ì´ ì €ì¥ ìš©ëŸ‰: {(X_train.nbytes + y_train.nbytes + X_val.nbytes + y_val.nbytes) / (1024**3):.2f} GB")
print("ğŸ’¡ ë‹¤ìŒë²ˆ Kernel ì¬ì‹œì‘ ì‹œ 15ì´ˆë§Œì— ë¡œë“œ ê°€ëŠ¥!")

print("\n" + "=" * 60)
print("âœ… ëª¨ë“  ì „ì²˜ë¦¬ ì™„ë£Œ! ë°ì´í„°ê°€ ë©”ëª¨ë¦¬ì— ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!")
print("=" * 60)